name: CI
on:
  push:
    tags:
      - '*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'æŒ‡å®š Clash for Windows çš„ç‰ˆæœ¬ (X.X.X)'
        required: true
        default: ''
        type: string

jobs:
  build:
    name: Build
    if: ${{ github.event_name == 'push' }}
    runs-on: windows-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          submodules: true
      - name: Clone BoyceLig/ClashSinicizationTool Repository
        uses: GuillaumeFalourd/clone-github-repo-action@v2
        with:
          owner: 'BoyceLig'
          repository: 'ClashSinicizationTool'
      - name: Setup .NET
        uses: actions/setup-dotnet@v2
        with:
          dotnet-version: 6.0.x
      - name: Setup NuGet
        shell: pwsh
        run: |
          cd ./ClashSinicizationTool
          dotnet nuget update source
          nuget restore ClashSinicizationTool.sln
      - name: Build .NET App
        shell: pwsh
        run: |
          cd ./ClashSinicizationTool
          ./build_cli.ps1 app
      - name: Unpack ClashSinicizationTool & Copy Project Files
        shell: pwsh
        run: |
          if (-not (Test-Path ./Build)) { New-Item -Path ./ -Name Build -ItemType Directory }
          Copy-Item -Path ./ClashSinicizationTool/Dist/Release/ -Destination ./Build/ClashSinicizationTool/ -Recurse -Force
          Copy-Item -Path ./ç¿»è¯‘è„šæœ¬.txt -Destination ./Build/ClashSinicizationTool/ -Force
          Copy-Item -Path ./moment-with-CN.js -Destination ./Build/ClashSinicizationTool/ -Force
      - name: Get Tag
        id: get_tag
        uses: dawidd6/action-get-tag@v1
      - name: Download Clash for Windows
        uses: robinraju/release-downloader@v1.5
        with:
          repository: "Fndroid/clash_for_windows_pkg"
          tag: ${{ steps.get_tag.outputs.tag }}
          fileName: "Clash.for.Windows-${{ steps.get_tag.outputs.tag }}-win.7z"
          tarBall: false
          zipBall: false
          out-file-path: "downloads"
      - name: Unpack Clash for Windows & Sinicization
        shell: pwsh
        run: |
          7z x ./downloads/Clash.for.Windows-${{ steps.get_tag.outputs.tag }}-win.7z -o"./Build/Clash"
          ./Build/ClashSinicizationTool/CLI.exe -c ./Build/Clash -t ./Build/ClashSinicizationTool/ç¿»è¯‘è„šæœ¬.txt -o ./Build
      - name: Package Asar
        shell: pwsh
        run: |
          7z a -mx9 "./Build/app.7z" "./Build/app.asar"
          Compress-Archive -Path "./Build/app.asar" -DestinationPath "./Build/app.zip"
      - name: Generate sha256sum file
        shell: pwsh
        run: |
          Get-FileHash -Algorithm SHA256 -Path "./Build/app.7z", "./Build/app.zip" | ForEach-Object { "$($_.Path | Split-Path -Leaf): $($_.Hash)" } | Out-File -FilePath "./Build/sha256sum"
      - name: Create Release
        uses: ncipollo/release-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          name: Clash for Windows v${{ steps.get_tag.outputs.tag }} æ±‰åŒ–è¡¥ä¸
          prerelease: false
          draft: false
          artifacts: "./Build/app.7z,./Build/app.zip,./Build/sha256sum"
          body: |
            [![](https://img.shields.io/badge/Channel-blue?label=Telegram&logo=telegram)](https://t.me/ClashR_for_Windows_Channel) [![](https://img.shields.io/badge/Group-green?label=Telegram&logo=telegram)](https://t.me/+Se4RSc06w8QK1HiS)

            âš ï¸æ±‰åŒ–æ°¸ä¹…å…è´¹ï¼Œè¯·æ³¨æ„æ¬ºè¯ˆï¼ï¼ï¼

            ## æ±‰åŒ–æ–¹æ³•ï¼š

            ä¸‹è½½ `app.7z` æˆ– `app.zip` æ–‡ä»¶(*ä¸¤ä¸ªå‹ç¼©åŒ…å†…å®¹ä¸€æ ·*)åï¼Œè§£å‹å‹ç¼©åŒ…ï¼Œè¯·è‡ªè¡Œæ›¿æ¢ä¸‹åˆ—è·¯å¾„ä¸­çš„ `app.asar` æ–‡ä»¶

            `Clash for Windows\resources\app.asar`

            ## ç›¸å…³æ¨èï¼š

            ### ç›¸å…³æ¨è1ï¼šé€æ—¥

            8.8æŠ˜ä¼˜æƒ å·ç ï¼šclash

            [é€æ—¥](http://zhuri.cc/auth/register?code=F9B0)
            [TGç¾¤ç»„ä¸€é”®ç›´è¾¾](https://t.me/zhuricc)
            [TGå…¬å‘Šæ¿ä¸€é”®ç›´è¾¾](https://t.me/okjiasuqi)

            ç‰¹è‰²å±æ€§ï¼š
            âœ…ä¸é™é€Ÿï¼Œä¸é™æ—¶ã€‚
            âœ…ä½¿ç”¨ä¸æ»¡æ„éšæ—¶ğŸ‰‘é€€æ¬¾ï¼ï¼ï¼
            âœ…å°Šé‡ç”¨æˆ·éšç§ï¼Œä¸ä¿ç•™ç”¨æˆ·ä½¿ç”¨è®°å½•ï¼ï¼ï¼
            âœ…å…è´¹æä¾›Netflixé«˜çº§è§†é¢‘ä¼šå‘˜è´¦å·ã€‚
            âœ…å…è´¹æä¾›iOSç¾åŒºidå†…å«å°ç«ç®­/åœˆXç­‰å¤šæ¬¾ä»˜è´¹è½¯ä»¶ã€‚
            è´­ä¹°å°ç«ç®­ã€Google voiceğŸ‘‰[ç¥é©¬æ‚è´§é“º](https://googlevoice.top/)
            Chatgptç½‘ç«™ğŸ‘‰[WOAIAIÂ·GPT](https://chat1.woaiai.cc/)


            ### ç›¸å…³æ¨è2ï¼šCherry VPN

            8æŠ˜ä¼˜æƒ å·ï¼šclash

            [Cherry VPN å®˜ç½‘](https://cherryvpn.net/auth/register?code=EO50)
            [è®¨è®ºç»„](https://t.me/cherrylink_vpn)
            [å…¬å‘Šæ¿ç›´è¾¾](https://t.me/cherrylink_channel)

            ç‰¹è‰²å±æ€§ï¼š
            âœ…å…¨SSéš§é“ä¸­è½¬èŠ‚ç‚¹.
            âœ…è½»æ¾å¸¦ä½ ç•…æ¸¸ä¸–ç•Œã€‚
            âœ…ä½¿ç”¨ä¸æ»¡æ„éšæ—¶ğŸ‰‘é€€æ¬¾ï¼ï¼ï¼
            âœ…å°Šé‡ç”¨æˆ·éšç§ï¼Œä¸ä¿ç•™ç”¨æˆ·ä½¿ç”¨è®°å½•ï¼ï¼ï¼

  manual:
    name: Manual
    if: ${{ github.event_name == 'workflow_dispatch' }}
    runs-on: windows-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          submodules: true
      - name: Clone BoyceLig/ClashSinicizationTool Repository
        uses: GuillaumeFalourd/clone-github-repo-action@v2
        with:
          owner: 'BoyceLig'
          repository: 'ClashSinicizationTool'
      - name: Setup .NET
        uses: actions/setup-dotnet@v2
        with:
          dotnet-version: 6.0.x
      - name: Setup NuGet
        shell: pwsh
        run: |
          cd ./ClashSinicizationTool
          dotnet nuget update source
          nuget restore ClashSinicizationTool.sln
      - name: Build .NET App
        shell: pwsh
        run: |
          cd ./ClashSinicizationTool
          ./build_cli.ps1 app
      - name: Unpack ClashSinicizationTool & Copy Project Files
        shell: pwsh
        run: |
          if (-not (Test-Path ./Build)) { New-Item -Path ./ -Name Build -ItemType Directory }
          Copy-Item -Path ./ClashSinicizationTool/Dist/Release/ -Destination ./Build/ClashSinicizationTool/ -Recurse -Force
          Copy-Item -Path ./ç¿»è¯‘è„šæœ¬.txt -Destination ./Build/ClashSinicizationTool/ -Force
          Copy-Item -Path ./moment-with-CN.js -Destination ./Build/ClashSinicizationTool/ -Force
      - name: Download Clash for Windows
        uses: robinraju/release-downloader@v1.5
        with:
          repository: "Fndroid/clash_for_windows_pkg"
          tag: ${{ inputs.version }}
          fileName: "Clash.for.Windows-${{ inputs.version }}-win.7z"
          tarBall: false
          zipBall: false
          out-file-path: "downloads"
      - name: Unpack Clash for Windows & Sinicization
        shell: pwsh
        run: |
          7z x ./downloads/Clash.for.Windows-${{ inputs.version }}-win.7z -o"./Build/Clash"
          ./Build/ClashSinicizationTool/CLI.exe -c ./Build/Clash -t ./Build/ClashSinicizationTool/ç¿»è¯‘è„šæœ¬.txt -o ./Build
      - name: Upload Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: app-${{ inputs.version }}
          path: ./Build/app.asar
